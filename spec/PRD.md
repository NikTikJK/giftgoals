# PRD: Социальный вишлист «GiftGoals»

**Версия документа**: 1.0 (февраль 2025).  
**Реализация**: фронтенд на React SPA, бэкенд на Express (Node.js) с PostgreSQL (см. п. 4).

## 1. Цель продукта

Создать веб‑приложение социального вишлиста, в котором пользователи:
- формируют и ведут списки желаний под разные поводы (ДР, НГ и т.д.);
- делятся списками по публичной ссылке;
- позволяют друзьям резервировать подарки и скидываться на дорогие позиции;
- получают реалтайм‑обновления статусов подарков.

Упор: простота для конечного пользователя, понятный шаринг, прозрачный статус подарков без спойлеров для владельца списка.

## 2. Основные пользовательские роли

- **Гость**: зашёл по публичной ссылке без регистрации. Может **полностью видеть вишлист** (название, описание, дата, все подарки с картинками, ценой, статусом «свободен» / «зарезервировано» / прогресс сбора). **Не видит**, кто именно резервирует пункты или вносит вклад. **Не может** сам резервировать подарки и скидываться — для этого нужна регистрация/вход.
- **Автор вишлиста (владелец)**: зарегистрированный пользователь, создаёт и редактирует списки желаний.
- **Друг (участник)**: зарегистрированный пользователь, открывший вишлист по ссылке (не владелец этого вишлиста); может резервировать подарки и вносить вклад в общий сбор. Владелец вишлиста не может резервировать подарки и вносить вклад в **свой** вишлист (при переходе по своей публичной ссылке действия «Зарезервировать» / «Скинуться» для него недоступны).

## 3. Основные пользовательские сценарии

### 3.1. Регистрация и авторизация

- **Регистрация**: по email + пароль.
- **Вход**:
  - по email + пароль;
  - по Google (OAuth): кнопка «Войти через Google», без ввода пароля.
- Оба способа входа должны вести к одному типу аккаунта (пользователь может потом привязать email или Google к одному профилю — опционально на MVP).

### 3.2. Управление профилем (MVP)

- Изменение имени отображаемого пользователя.
- Изменение пароля.
- Выход из аккаунта.

### 3.3. Создание и управление вишлистами

- Создание нового вишлиста:
  - название списка (обязательно);
  - описание/повод (опционально);
  - дата события (опционально, но рекомендуется);
  - при создании листа можно сразу добавлять желаемые подарки (поля подарков — см. п. 3.4).
- Просмотр списка своих вишлистов.
- Редактирование:
  - изменение названия/описания/даты;
  - включение/отключение публичной ссылки;
  - добавление, изменение и удаление подарков в листе;
  - удаление вишлиста (при удалении все резервы и вклады по этому вишлисту считаются аннулированными; в MVP возврат средств не предусмотрен).
- Публичная ссылка:
  - генерируется уникальный slug/ID;
  - по ссылке доступен просмотр списка без авторизации;
  - при переходе по публичной ссылке **с авторизованного аккаунта** пользователь может взаимодействовать с листом как Друг (резервировать, вносить вклад), **если он не владелец этого вишлиста** (владелец в своём вишлисте по ссылке не резервирует и не скидывается, см. п. 3.5–3.7).

### 3.4. Управление подарками внутри вишлиста

- Добавление подарка:
  - название (обязательно);
  - ссылка на товар (URL);
  - ориентировочная цена;
  - картинка (URL или загрузка — на MVP достаточно URL);
  - комментарий/пояснение (опционально).
- Редактирование подарка (те же поля). Если у «дорогого» подарка уже есть вклады, изменение цены пересчитывает целевую сумму сбора (текущая собранная сумма не меняется). Удаление подарка: при удалении подарка его резерв и вклады аннулируются (в MVP возврат не предусмотрен).
- Удаление подарка.
- **Тип подарка определяется автоматически** по пороговой цене:
  - если ориентировочная цена подарка **ниже** порога — подарок считается обычным (доступно только резервирование одним человеком);
  - если цена **достигает или превышает** порог — подарок считается «дорогим» (доступен групповой сбор, см. п. 3.7).
- Пороговая цена задаётся **владельцем в настройках каждого вишлиста** (у каждого списка свой порог; от него зависит, какие подарки считаются «дорогими» и доступны для группового сбора). Если при создании вишлиста порог не задан, используется значение по умолчанию **5000 ₽** (см. п. 4).

### 3.5. Просмотр вишлиста по публичной ссылке (роль: Гость/Друг)

- **Гость (без регистрации)**:
  - видит вишлист **полностью**: название, описание, дата события, все подарки с картинками, ценой и статусом (например «свободен», «зарезервировано», прогресс сбора в %);
  - **не видит**, кто резервирует пункты и кто сколько внёс в сбор;
  - **не может** резервировать подарки и скидываться — при попытке действия показывается всплывающее предупреждение/модальное окно с предложением зарегистрироваться/войти; при этом пользователь остаётся на странице текущего вишлиста, а после успешного входа/регистрации может продолжить действие без потери контекста.
- **Друг (залогинен, не владелец вишлиста)**:
  - тот же просмотр плюс возможность резервировать и вносить вклад (см. п. 3.6, 3.7);
  - видит личности (имя/аватар) пользователей, которые зарезервировали подарки (см. п. 3.6).
- **Владелец вишлиста** при открытии своего вишлиста по публичной ссылке видит тот же контент, но кнопки резерва и вклада для него недоступны (см. п. 2).

### 3.6. Резервирование подарка (роль: Друг)

- Резервировать может только **зарегистрированный пользователь (Друг)**, причём не владелец данного вишлиста. Гость и владелец своего вишлиста резервировать не могут.
- Друг может:
  - зарезервировать обычный подарок (статус: «зарезервировано»); резерв создаётся только если подарок в момент запроса свободен, иначе пользователю возвращается ошибка (см. п. 4, конкурентные операции);
  - снять свой резерв до даты события вишлиста (после даты события резерв окончательный, см. п. 4).
- Ограничения по видимости:
  - **Владелец вишлиста не видит**, кто именно зарезервировал;
  - **Гость не видит**, кто резервировал — только факт «зарезервировано»;
  - друзья (залогиненные) видят факт резерва и личности резервистов (имя/аватар).

### 3.7. Групповой сбор на дорогой подарок

- Для подарка, цена которого достигла или превысила пороговую (тип «дорогой» определяется автоматически, см. п. 3.4), вместо простого резерва доступен режим «Сбор средств».
- Вносить вклад может только **зарегистрированный пользователь (Друг)**, причём не владелец данного вишлиста. Гость и владелец своего вишлиста вносить вклад не могут.
- Минимальной суммы вклада нет: можно вносить любую положительную сумму (строго больше 0).
- Друг может:
  - ввести сумму своего вклада;
  - отправить вклад (в MVP достаточно логического учёта без реального платежного шлюза); вклад принимается только если сумма сбора не превысит цель, иначе возвращается ошибка (см. п. 4, конкурентные операции).
- Отображение:
  - прогресс‑бар: сумма собрана / целевая сумма;
  - при вводе суммы система **не даёт ввести вклад, который переполнит цель**: максимально допустимый вклад ограничивается так, чтобы сумма стала ровно равна целевой, но не превышала её (оверфандинг запрещён);
  - если к дате события сумма не набрана: владелец вишлиста может **продлить сбор** по этому подарку (указать новую дату или оставить сбор открытым); участникам и владельцу отправляются **уведомления** о недоборе **за 3 дня до даты события** и **в день события** (текст вида «по подарку X собрано 60%, до цели осталось Y»). Если у вишлиста не задана дата события, уведомления о недоборе не отправляются (см. п. 4). Канал по умолчанию — in-app; при реализации можно добавить email.
- Ограничения по видимости:
  - владелец не видит, **кто** и **сколько** внёс;
  - **гость не видит**, кто внёс и сколько — только общий прогресс (например, «собрано 60%»);
  - друзья (залогиненные) видят прогресс и, опционально, анонимное количество участников.

### 3.8. Реалтайм‑обновления

- При резервировании подарка или внесении вклада:
  - все открытые клиенты с этим вишлистом получают обновление без перезагрузки (WebSocket / SSE).
- События в реалтайме:
  - изменение статуса подарка (свободен → зарезервирован);
  - изменение прогресса сбора;
  - снятие резерва.

### 3.9. Предложение подарков (Phase 2 / после MVP)

- **Кто может предлагать**: только залогиненные пользователи (Друзья), открывшие вишлист по ссылке. Гость не может предлагать подарки.
- **Суть**: Друг может отправить **предложение подарка** в вишлист — те же поля, что у обычного подарка (название, ссылка, цена, картинка, комментарий). Предложение попадает в очередь «Предложения» у владельца вишлиста и не отображается в публичном списке подарков до решения владельца.
- **Решение владельца**: владелец вишлиста видит список предложений и по каждому может нажать **Принять** (подарок добавляется в вишлист как обычный пункт) или **Отклонить** (предложение удаляется из очереди). Владелец **не видит**, кто предложил подарок — соблюдается анонимность предложившего.
- **Лимиты**: не более **20** предложений в статусе «ожидает решения» на один вишлист и не более **2** предложений от одного пользователя на один вишлист (см. п. 4).
- **Уведомления**: при принятии или отклонении предложения система уведомляет предложившего (без раскрытия личности владельца — только факт «ваше предложение принято» / «отклонено»). Канал по умолчанию — in-app (см. п. 4).

## 4. Нефункциональные и технические требования

- **Архитектура**: проект реализуется как разделённый стек: фронтенд на React SPA и отдельный бэкенд на Express. Обмен данными между фронтендом и бэкендом осуществляется по REST/JSON API поверх HTTP.
- **Фронтенд (SPA)**: отдельное React-приложение (React + TypeScript, например Vite), собираемое в статический бандл и работающее в браузере; использует REST API бэкенда для всех операций с данными.
- **Бэкенд**: Express (Node.js, предпочтительно TypeScript), реализующий REST/JSON API по сценариям, описанным в этом PRD (авторизация, CRUD вишлистов и подарков, резервы, вклады, реалтайм‑обновления).
- **База данных и доступ к данным**: PostgreSQL (managed, например Supabase/Railway/Render), доступ через ORM/Query Builder (Prisma, Drizzle или аналог).
- **Авторизация**: email + пароль (регистрация и вход) и вход через Google (OAuth); хранение паролей с хешированием (bcrypt или argon2); минимальные требования к сложности пароля — при реализации. Сессия/токен (JWT в httpOnly cookie или аналог) с проверкой на каждом запросе к API.
- **Безопасность и валидация**: на API проверять роль пользователя (владелец вишлиста — только для своих списков; резерв/вклад — только не владелец этого вишлиста). Валидация ввода: ограничение длины названия, описания, URL; цена подарка и вклад — неотрицательные числа; slug публичной ссылки — уникальный, неперебираемый (достаточно длинный случайный идентификатор). При реализации предусмотреть rate limit на регистрацию, вход и при необходимости на просмотр по публичной ссылке.
- **Публичная ссылка** на вишлист работает **без регистрации** (только просмотр).
- **Адаптивность**: корректное отображение на мобильных экранах.
- **Лимиты (мягкие)**: не более 50 вишлистов на один аккаунт; не более 200 подарков в одном вишлисте. При достижении лимита отображать сообщение и не давать создавать новые.
- **Системные константы и значения по умолчанию** (устанавливаются системой, при необходимости настраиваются владельцем только где указано):
  - **Пороговая цена «дорогой» по умолчанию**: при создании вишлиста, если владелец не задал порог, используется **5000 ₽** (владелец может изменить в настройках вишлиста).
  - **Уведомления о недоборе** (групповой сбор): отправка **за 3 дня до даты события** и **в день события**; канал по умолчанию — **in-app** (уведомления в приложении при следующем входе); при реализации можно добавить email. Если дата события вишлиста **не задана**, уведомления о недоборе не отправляются (дедлайн сбора для такого подарка считается отсутствующим, пока владелец не продлит сбор с указанием даты).
  - **Снятие резерва**: разрешено **до даты события вишлиста**; после даты события резерв считается окончательным, снять нельзя. Если дата события вишлиста **не задана**, снять резерв можно в любой момент (ограничение по дате не действует).
  - **Предложения подарков (Phase 2)**: не более **20** предложений в статусе «ожидает решения» на один вишлист; не более **2** предложений от одного пользователя на один вишлист. Уведомление предложившему при принятии/отклонении — по умолчанию **in-app**.
- **Валюта и хранение цен**: единая валюта — рубли (RUB). Цены и вклады хранить в минимальных единицах (копейки) целым числом; отображение в рублях — на фронте. Порог «дорогой» и значение по умолчанию 5000 ₽ задаются в рублях, при хранении приводятся к копейкам.
- **Реалтайм и уведомления (технически)**: на MVP допускается обновление данных без перезагрузки через короткий polling (интервал 5–15 с) или SSE; при выборе serverless-хостинга без долгоживущих соединений WebSocket может потребовать отдельный сервис — при реализации выбрать подход под выбранный хостинг. In-app уведомления хранятся в БД (таблица уведомлений по пользователю), отображаются при входе и при открытом приложении по возможности.
- **Конкурентные операции**: резерв обычного подарка выполняется только если подарок в момент запроса свободен (проверка на бэкенде в одной операции с созданием резерва); при конфликте (уже зарезервирован) пользователю возвращается ошибка и сообщение. Вклад в групповой сбор в одной транзакции с проверкой, что сумма сбора не превысит цель; при конфликте — ошибка и сообщение пользователю (см. п. 3.6, 3.7).
- **Лимиты и ошибки API**: при достижении лимита (вишлисты, подарки, предложения) API возвращает понятную ошибку (например, 403 или 400 с кодом), фронт показывает сообщение пользователю (см. п. 4, лимиты).
- **Деплой**:
  - фронтенд (React SPA): статический хостинг (Vercel, Netlify, Cloudflare Pages и т.п.), сборка фронтенда как набора статических файлов;
  - бэкенд (Express) + PostgreSQL: PaaS (Railway, Render, Fly.io и т.п.) с поддержкой Node.js и переменных окружения (`DATABASE_URL` и другие секреты).

## 5. UX‑требования (предварительно)

Данный раздел фиксирует только ключевые UX‑принципы для MVP. Полное описание экранов, пользовательских потоков и состояний см. в документе «UX‑спецификация GiftGoals» (`spec/UX.md`), который дополняет и уточняет этот PRD.

- Понятный пустой вишлист:
  - текст/иллюстрация с объяснением, что здесь появятся желаемые подарки;
  - CTA‑кнопка «Добавить первый подарок».
- Страница по публичной ссылке:
  - гость видит полный вишлист (без имён резервов/вкладчиков); кнопки «Зарезервировать» / «Скинуться» ведут к предложению войти или зарегистрироваться;
  - простая структура: шапка списка, затем карточки подарков.
- Состояния ошибок:
  - вишлист удалён или недоступен;
  - подарок недоступен для резерва (уже зарезервирован или сбор закрыт).

## 6. Открытые продуктовые вопросы (для уточнения)

Зафиксированные решения (ранее открытые):
- **Минимальный вклад**: не вводится; допустима любая положительная сумма (> 0).
- **Переполнение сбора**: оверфандинг запрещён — вклад можно только довести цель до целевой суммы, не больше (см. п. 3.7).
- **Лимиты**: до 50 вишлистов на аккаунт, до 200 подарков в одном вишлисте (см. п. 4).
- **Пороговая цена «дорогой»**: настраивается владельцем в настройках каждого вишлиста (см. п. 3.4).
- **Недобор к дате события (дорогой подарок)**: комбинация **продления сбора** и **уведомлений**. Владелец может продлить сбор (новая дата или без даты); уведомления о недоборе — за **3 дня** до даты и **в день события**, канал по умолчанию in-app (см. п. 3.7 и п. 4).

## 7. MVP‑объём

Для первой версии (MVP) достаточно реализовать:

1. Регистрация по email + пароль, вход по email + пароль и по Google.
2. Личный список вишлистов владельца.
3. Создание/редактирование/удаление вишлиста.
4. Добавление/редактирование/удаление подарков.
5. Публичную страницу вишлиста (просмотр без регистрации).
6. Резервирование подарков (без раскрытия личности/сумм владельцу).
7. Групповой сбор с прогресс‑баром (без реальных платежей).
8. Реалтайм‑обновления статусов подарков и прогресса сбора.
9. Адаптивную вёрстку под мобильные.

**После MVP (Phase 2):** предложение подарков друзьями с принятием/отклонением владельцем и анонимностью предложившего (см. п. 3.9).

---

## Глоссарий

- **Вишлист** — список желаний (подарков), созданный владельцем и доступный по публичной ссылке.
- **Владелец** — автор вишлиста; создаёт и редактирует список, не видит, кто резервирует и вносит вклад.
- **Гость** — пользователь без регистрации, открывший вишлист по ссылке; только просмотр.
- **Друг** — залогиненный пользователь (не владелец), открывший вишлист по ссылке; может резервировать и вносить вклад.
- **Обычный подарок** — подарок с ценой ниже порога; доступно только резервирование одним человеком.
- **Дорогой подарок** — подарок с ценой не ниже порога; доступен групповой сбор.
- **Резерв** — фиксация обычного подарка за одним Другом.
- **Вклад** — сумма, внесённая Другом в групповой сбор по дорогому подарку.
- **Предложение (Phase 2)** — подарок, предложенный Другом владельцу на добавление в вишлист; владелец принимает или отклоняет.